<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è®¢å• - å­¦ç¼˜å®¶æ•™é€š</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .navbar { background: rgba(255,255,255,0.95); padding: 1rem 0; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #667eea; text-decoration: none; }
        .nav-links { display: flex; list-style: none; gap: 2rem; }
        .nav-links a { text-decoration: none; color: #333; font-weight: 500; }
        .nav-links a:hover { color: #667eea; }
        
        .main-content { margin-top: 80px; padding: 2rem 20px; max-width: 1000px; margin-left: auto; margin-right: auto; }
        
        .page-header { background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .page-title { font-size: 1.5rem; color: #333; margin-bottom: 1rem; }
        
        .tabs { display: flex; gap: 10px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: #f0f0f0; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover:not(.active) { background: #e0e0e0; }
        
        .role-switch { display: flex; gap: 10px; margin-bottom: 1rem; }
        .role-btn { padding: 8px 16px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; }
        .role-btn.active { background: #667eea; color: white; }
        
        .order-list { display: flex; flex-direction: column; gap: 1rem; }
        .order-card { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
        .order-no { font-weight: 600; color: #333; }
        .order-status { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-accepted { background: #d4edda; color: #155724; }
        .status-ongoing { background: #cce5ff; color: #004085; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-cancelled, .status-rejected { background: #f8d7da; color: #721c24; }
        
        .order-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .info-item { }
        .info-label { color: #888; font-size: 0.85rem; margin-bottom: 5px; }
        .info-value { color: #333; font-weight: 500; }
        
        .order-actions { display: flex; gap: 10px; padding-top: 1rem; border-top: 1px solid #eee; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn:hover { transform: translateY(-2px); }
        
        .empty-state { background: white; border-radius: 15px; padding: 4rem 2rem; text-align: center; color: #666; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .empty-state .icon { font-size: 4rem; margin-bottom: 1rem; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 2rem; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        .toast { position: fixed; top: 100px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; z-index: 3000; animation: slideIn 0.3s ease; }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .order-info { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">å­¦ç¼˜å®¶æ•™é€š</a>
            <ul class="nav-links">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="profile.html">ä¸ªäººä¸­å¿ƒ</a></li>
                <li><a href="messages.html">æˆ‘çš„æ¶ˆæ¯</a></li>
                <li><a href="orders.html" style="color: #667eea;">æˆ‘çš„è®¢å•</a></li>
            </ul>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">ğŸ“‹ æˆ‘çš„è®¢å•</h1>
            
            <div class="role-switch">
                <button class="role-btn active" data-role="parent" onclick="switchRole('parent')">ä½œä¸ºå®¶é•¿</button>
                <button class="role-btn" data-role="tutor" onclick="switchRole('tutor')">ä½œä¸ºå®¶æ•™</button>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-status="">å…¨éƒ¨</div>
                <div class="tab" data-status="pending">å¾…ç¡®è®¤</div>
                <div class="tab" data-status="accepted">å·²æ¥å—</div>
                <div class="tab" data-status="ongoing">è¿›è¡Œä¸­</div>
                <div class="tab" data-status="completed">å·²å®Œæˆ</div>
                <div class="tab" data-status="cancelled">å·²å–æ¶ˆ</div>
            </div>
        </div>
        
        <div class="order-list" id="orderList">
            <div class="empty-state">
                <div class="icon">ğŸ“‹</div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </main>

    <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è®¢å•è¯¦æƒ…</h3>
                <button class="close-btn" onclick="closeModal('orderModal')">Ã—</button>
            </div>
            <div id="orderDetail"></div>
        </div>
    </div>

    <!-- å–æ¶ˆåŸå› æ¨¡æ€æ¡† -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å–æ¶ˆè®¢å•</h3>
                <button class="close-btn" onclick="closeModal('cancelModal')">Ã—</button>
            </div>
            <form id="cancelForm">
                <input type="hidden" id="cancelOrderId">
                <div class="form-group">
                    <label>å–æ¶ˆåŸå› </label>
                    <textarea id="cancelReason" placeholder="è¯·è¾“å…¥å–æ¶ˆåŸå› ï¼ˆé€‰å¡«ï¼‰"></textarea>
                </div>
                <button type="submit" class="btn btn-danger" style="width: 100%;">ç¡®è®¤å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <!-- è¯„ä»·æ¨¡æ€æ¡† -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è¯„ä»·å®¶æ•™è€å¸ˆ</h3>
                <button class="close-btn" onclick="closeModal('reviewModal')">Ã—</button>
            </div>
            <form id="reviewForm">
                <input type="hidden" id="reviewOrderId">
                <input type="hidden" id="reviewTutorId">
                <div class="form-group">
                    <label>è¯„åˆ†</label>
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-value="1">â­</span>
                        <span class="star" data-value="2">â­</span>
                        <span class="star" data-value="3">â­</span>
                        <span class="star" data-value="4">â­</span>
                        <span class="star" data-value="5">â­</span>
                    </div>
                    <input type="hidden" id="reviewRating" value="5">
                </div>
                <div class="form-group">
                    <label>è¯„ä»·å†…å®¹</label>
                    <textarea id="reviewContent" placeholder="è¯·åˆ†äº«æ‚¨çš„å®¶æ•™ä½“éªŒ..."></textarea>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="reviewAnonymous"> åŒ¿åè¯„ä»·</label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤è¯„ä»·</button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentRole = 'parent';
        let currentStatus = '';
        let selectedRating = 5;

        document.addEventListener('DOMContentLoaded', function() {
            currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (!currentUser || !currentUser.id) {
                window.location.href = 'login.html';
                return;
            }
            
            loadOrders();
            
            // çŠ¶æ€åˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentStatus = this.dataset.status;
                    loadOrders();
                });
            });
            
            // è¯„åˆ†æ˜Ÿæ˜Ÿç‚¹å‡»
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.value);
                    document.getElementById('reviewRating').value = selectedRating;
                    updateStars();
                });
            });
        });

        function toast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function switchRole(role) {
            currentRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.role === role);
            });
            loadOrders();
        }

        function loadOrders() {
            fetch(`api_orders.php?action=get_list&user_id=${currentUser.id}&role=${currentRole}&status=${currentStatus}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('orderList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(o => renderOrderCard(o)).join('');
                    } else {
                        container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“‹</div><p>æš‚æ— ${currentStatus ? getStatusText(currentStatus) : ''}è®¢å•</p></div>`;
                    }
                })
                .catch(() => {
                    document.getElementById('orderList').innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><p>æš‚æ— è®¢å•</p></div>';
                });
        }

        function getStatusText(status) {
            const map = {pending:'å¾…ç¡®è®¤',accepted:'å·²æ¥å—',rejected:'å·²æ‹’ç»',ongoing:'è¿›è¡Œä¸­',completed:'å·²å®Œæˆ',cancelled:'å·²å–æ¶ˆ'};
            return map[status] || status;
        }

        function renderOrderCard(order) {
            const isParent = currentRole === 'parent';
            const canAccept = !isParent && order.status === 'pending';
            const canCancel = order.status === 'pending' || order.status === 'accepted';
            const canComplete = order.status === 'ongoing';
            const canReview = isParent && order.status === 'completed';
            
            return `
                <div class="order-card">
                    <div class="order-header">
                        <span class="order-no">è®¢å•å·ï¼š${order.order_no}</span>
                        <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
                    </div>
                    <div class="order-info">
                        <div class="info-item">
                            <div class="info-label">å­¦ç”Ÿå§“å</div>
                            <div class="info-value">${order.student_name || '-'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç§‘ç›®</div>
                            <div class="info-value">${order.subjects || '-'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${isParent ? 'å®¶æ•™è€å¸ˆ' : 'å®¶é•¿'}</div>
                            <div class="info-value">${isParent ? (order.tutor_name || '-') : (order.parent_name || '-')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ä¸Šè¯¾åœ°ç‚¹</div>
                            <div class="info-value">${order.location || '-'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">è¯¾æ—¶è´¹</div>
                            <div class="info-value">Â¥${order.price_per_hour || 0}/å°æ—¶</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                            <div class="info-value">${order.created_at}</div>
                        </div>
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-secondary" onclick="viewOrderDetail(${order.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                        ${canAccept ? `
                            <button class="btn btn-success" onclick="updateStatus(${order.id}, 'accepted')">æ¥å—</button>
                            <button class="btn btn-danger" onclick="updateStatus(${order.id}, 'rejected')">æ‹’ç»</button>
                        ` : ''}
                        ${canCancel ? `<button class="btn btn-warning" onclick="openCancelModal(${order.id})">å–æ¶ˆè®¢å•</button>` : ''}
                        ${canComplete ? `<button class="btn btn-success" onclick="completeOrder(${order.id})">ç¡®è®¤å®Œæˆ</button>` : ''}
                        ${canReview ? `<button class="btn btn-primary" onclick="openReviewModal(${order.id}, ${order.tutor_id})">è¯„ä»·</button>` : ''}
                    </div>
                </div>
            `;
        }

        function viewOrderDetail(orderId) {
            fetch(`api_orders.php?action=get_detail&order_id=${orderId}&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const o = data.data;
                        document.getElementById('orderDetail').innerHTML = `
                            <div style="line-height: 2;">
                                <p><strong>è®¢å•å·ï¼š</strong>${o.order_no}</p>
                                <p><strong>çŠ¶æ€ï¼š</strong>${getStatusText(o.status)}</p>
                                <p><strong>å­¦ç”Ÿï¼š</strong>${o.student_name || '-'}</p>
                                <p><strong>ç§‘ç›®ï¼š</strong>${o.subjects || '-'}</p>
                                <p><strong>ä¸Šè¯¾æ—¶é—´ï¼š</strong>${o.schedule || '-'}</p>
                                <p><strong>ä¸Šè¯¾åœ°ç‚¹ï¼š</strong>${o.location || '-'}</p>
                                <p><strong>å®¶æ•™è€å¸ˆï¼š</strong>${o.tutor_name || '-'}</p>
                                <p><strong>è¯¾æ—¶è´¹ï¼š</strong>Â¥${o.price_per_hour || 0}/å°æ—¶</p>
                                <p><strong>æ€»è¯¾æ—¶ï¼š</strong>${o.total_hours || 0}å°æ—¶</p>
                                <p><strong>æ€»é‡‘é¢ï¼š</strong>Â¥${o.total_amount || 0}</p>
                                <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${o.created_at}</p>
                                ${o.notes ? `<p><strong>å¤‡æ³¨ï¼š</strong>${o.notes}</p>` : ''}
                                ${o.cancel_reason ? `<p><strong>å–æ¶ˆåŸå› ï¼š</strong>${o.cancel_reason}</p>` : ''}
                            </div>
                        `;
                        document.getElementById('orderModal').style.display = 'block';
                    }
                });
        }

        function updateStatus(orderId, status) {
            const action = status === 'accepted' ? 'æ¥å—' : 'æ‹’ç»';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªè®¢å•å—ï¼Ÿ`)) return;
            
            fetch('api_orders.php?action=update_status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    order_id: orderId,
                    user_id: currentUser.id,
                    status: status
                })
            })
            .then(r => r.json())
            .then(data => {
                toast(data.message, data.success ? 'success' : 'error');
                if (data.success) loadOrders();
            });
        }

        function openCancelModal(orderId) {
            document.getElementById('cancelOrderId').value = orderId;
            document.getElementById('cancelModal').style.display = 'block';
        }

        document.getElementById('cancelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const orderId = document.getElementById('cancelOrderId').value;
            const reason = document.getElementById('cancelReason').value;
            
            fetch('api_orders.php?action=cancel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    order_id: orderId,
                    user_id: currentUser.id,
                    reason: reason
                })
            })
            .then(r => r.json())
            .then(data => {
                toast(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    closeModal('cancelModal');
                    loadOrders();
                }
            });
        });

        function completeOrder(orderId) {
            const hours = prompt('è¯·è¾“å…¥å®é™…ä¸Šè¯¾è¯¾æ—¶æ•°ï¼š', '10');
            if (!hours) return;
            
            fetch('api_orders.php?action=complete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    order_id: orderId,
                    user_id: currentUser.id,
                    total_hours: parseFloat(hours)
                })
            })
            .then(r => r.json())
            .then(data => {
                toast(data.message, data.success ? 'success' : 'error');
                if (data.success) loadOrders();
            });
        }

        function openReviewModal(orderId, tutorId) {
            document.getElementById('reviewOrderId').value = orderId;
            document.getElementById('reviewTutorId').value = tutorId;
            selectedRating = 5;
            updateStars();
            document.getElementById('reviewModal').style.display = 'block';
        }

        function updateStars() {
            document.querySelectorAll('.star').forEach((star, index) => {
                star.style.opacity = index < selectedRating ? 1 : 0.3;
            });
        }

        document.getElementById('reviewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            fetch('api_reviews.php?action=add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    reviewer_id: currentUser.id,
                    tutor_id: document.getElementById('reviewTutorId').value,
                    order_id: document.getElementById('reviewOrderId').value,
                    rating: selectedRating,
                    content: document.getElementById('reviewContent').value,
                    is_anonymous: document.getElementById('reviewAnonymous').checked ? 1 : 0
                })
            })
            .then(r => r.json())
            .then(data => {
                toast(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    closeModal('reviewModal');
                    document.getElementById('reviewForm').reset();
                }
            });
        });

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>

