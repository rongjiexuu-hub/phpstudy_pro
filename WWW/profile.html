<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - å­¦ç¼˜å®¶æ•™é€š</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-size: 1.5rem; font-weight: bold; color: #667eea; text-decoration: none; }
        .nav-links { display: flex; list-style: none; gap: 2rem; }
        .nav-links a { text-decoration: none; color: #333; font-weight: 500; }
        .nav-links a:hover { color: #667eea; }
        
        .main-content {
            margin-top: 80px;
            padding: 2rem 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .profile-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        .user-info { text-align: center; margin-bottom: 2rem; }
        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0 auto 1rem;
        }
        .username { font-size: 1.25rem; font-weight: 600; color: #333; }
        .user-type { color: #667eea; font-size: 0.9rem; margin-top: 0.5rem; }
        .verified-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .menu { list-style: none; }
        .menu li {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .menu li:hover, .menu li.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .menu li .badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: auto;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .stat-value { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 0.9rem; margin-top: 0.5rem; }
        
        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        .content-title { font-size: 1.5rem; font-weight: 600; color: #333; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ä¿¡æ¯å¡ç‰‡ */
        .info-card {
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .info-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .info-title { font-size: 1.1rem; font-weight: 600; color: #333; }
        .info-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .info-meta { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .info-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        
        /* è¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        /* æ¶ˆæ¯æç¤º */
        .message {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }
        .message.success { background: #28a745; }
        .message.error { background: #dc3545; }
        .message.info { background: #17a2b8; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        .empty-state .icon { font-size: 4rem; margin-bottom: 1rem; }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .profile-container { grid-template-columns: 1fr; }
            .nav-links { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">å­¦ç¼˜å®¶æ•™é€š</a>
            <ul class="nav-links">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="index.html#tutors">æ‰¾å®¶æ•™</a></li>
                <li><a href="index.html#jobs">å®¶æ•™ä¿¡æ¯</a></li>
                <li><a href="profile.html" style="color: #667eea;">ä¸ªäººä¸­å¿ƒ</a></li>
                <li><a href="messages.html">æ¶ˆæ¯</a></li>
                <li><a href="orders.html">è®¢å•</a></li>
            </ul>
            <div>
                <button class="btn btn-danger" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statProfiles">0</div>
                <div class="stat-label">å‘å¸ƒçš„å®¶æ•™ä¿¡æ¯</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statRequests">0</div>
                <div class="stat-label">å‘å¸ƒçš„éœ€æ±‚</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statFavorites">0</div>
                <div class="stat-label">æˆ‘çš„æ”¶è—</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statOrders">0</div>
                <div class="stat-label">æˆ‘çš„è®¢å•</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statMessages">0</div>
                <div class="stat-label">æœªè¯»æ¶ˆæ¯</div>
            </div>
        </div>

        <div class="profile-container">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">ç”¨</div>
                    <div class="username" id="displayName">ç”¨æˆ·å</div>
                    <div class="user-type" id="userType">æ™®é€šç”¨æˆ·</div>
                    <div class="verified-badge" id="verifiedBadge" style="display: none;">å·²è®¤è¯</div>
                </div>
                <ul class="menu">
                    <li class="active" onclick="switchTab('profile')">ğŸ‘¤ ä¸ªäººèµ„æ–™</li>
                    <li onclick="switchTab('my-tutor')">ğŸ“ æˆ‘è¦æ‰¾å­¦ç”Ÿï¼ˆå®¶æ•™ä¿¡æ¯ï¼‰</li>
                    <li onclick="switchTab('my-requests')">ğŸ“ æˆ‘è¦æ‰¾è€å¸ˆï¼ˆå®¶æ•™éœ€æ±‚ï¼‰</li>
                    <li onclick="switchTab('favorites')">â­ æˆ‘çš„æ”¶è—</li>
                    <li onclick="switchTab('orders')">ğŸ“‹ æˆ‘çš„è®¢å•</li>
                    <li onclick="switchTab('messages')">ğŸ’¬ æˆ‘çš„æ¶ˆæ¯ <span class="badge" id="msgBadge" style="display: none;">0</span></li>
                    <li onclick="switchTab('reviews')">â­ æˆ‘çš„è¯„ä»·</li>
                    <li onclick="switchTab('verification')">âœ… èº«ä»½è®¤è¯</li>
                    <li onclick="switchTab('security')">ğŸ”’ è´¦å·å®‰å…¨</li>
                </ul>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-area">
                <!-- ä¸ªäººèµ„æ–™ -->
                <div id="tab-profile" class="tab-content active">
                    <div class="content-header">
                        <h2 class="content-title">ä¸ªäººèµ„æ–™</h2>
                        <button class="btn btn-primary" onclick="saveProfile()">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                    <form id="profileForm">
                        <div class="form-group">
                            <label>ç”¨æˆ·åï¼ˆæ³¨å†Œæ—¶è®¾ç½®ï¼Œä¸å¯ä¿®æ”¹ï¼‰</label>
                            <input type="text" id="profileUsername" disabled style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>æ˜µç§°ï¼ˆå¯ä¿®æ”¹ï¼‰</label>
                            <input type="text" id="profileNickname" placeholder="è¯·è¾“å…¥æ˜µç§°">
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±ï¼ˆå¯ä¿®æ”¹ï¼‰</label>
                            <input type="email" id="profileEmail" placeholder="è¯·è¾“å…¥é‚®ç®±">
                        </div>
                        <div class="form-group">
                            <label>æ‰‹æœºå·ç </label>
                            <input type="tel" id="profilePhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
                        </div>
                        <div class="form-group">
                            <label>ç”¨æˆ·ç±»å‹</label>
                            <select id="profileUserType">
                                <option value="both">å®¶é•¿å’Œå®¶æ•™</option>
                                <option value="parent">ä»…å®¶é•¿</option>
                                <option value="tutor">ä»…å®¶æ•™</option>
                            </select>
                        </div>
                    </form>
                </div>

                <!-- æˆ‘è¦æ‰¾å­¦ç”Ÿï¼ˆæˆ‘å‘å¸ƒçš„å®¶æ•™ä¿¡æ¯ï¼‰ -->
                <div id="tab-my-tutor" class="tab-content">
                    <div class="content-header">
                        <h2 class="content-title">æˆ‘è¦æ‰¾å­¦ç”Ÿï¼ˆæˆ‘å‘å¸ƒçš„å®¶æ•™ä¿¡æ¯ï¼‰</h2>
                        <button class="btn btn-primary" onclick="goToPublishTutor()">å‘å¸ƒå®¶æ•™ä¿¡æ¯</button>
                    </div>
                    <div id="myTutorList"></div>
                </div>

                <!-- æˆ‘çš„éœ€æ±‚ -->
                <div id="tab-my-requests" class="tab-content">
                    <div class="content-header">
                        <h2 class="content-title">æˆ‘è¦æ‰¾è€å¸ˆï¼ˆæˆ‘å‘å¸ƒçš„å®¶æ•™éœ€æ±‚ï¼‰</h2>
                        <button class="btn btn-primary" onclick="goToPublishRequest()">å‘å¸ƒå®¶æ•™éœ€æ±‚</button>
                    </div>
                    <div id="myRequestsList"></div>
                </div>

                <!-- æˆ‘çš„æ”¶è— -->
                <div id="tab-favorites" class="tab-content">
                    <div class="content-header">
                        <h2 class="content-title">æˆ‘çš„æ”¶è—</h2>
                    </div>
                    <div id="favoritesList"></div>
                </div>

                <!-- æˆ‘çš„è®¢å• -->
                <div id="tab-orders" class="tab-content">
                    <div class="content-header">
                        <h2 class="content-title">æˆ‘çš„è®¢å•</h2>
                    </div>
                    <div id="ordersList"></div>
                </div>

                <!-- æˆ‘çš„æ¶ˆæ¯ -->
                <div id="tab-messages" class="tab-content">
                    <div class="content-header">
                        <h2 class="content-title">æˆ‘çš„æ¶ˆæ¯</h2>
                        <button class="btn btn-secondary" onclick="markAllRead()">å…¨éƒ¨å·²è¯»</button>
                    </div>
                    <div id="messagesList"></div>
                </div>

                <!-- æˆ‘çš„è¯„ä»· -->
                <div id="tab-reviews" class="tab-content">
                    <div class="content-header">
                        <h2 class="content-title">æˆ‘çš„è¯„ä»·</h2>
                    </div>
                    <div id="reviewsList"></div>
                </div>

                <!-- èº«ä»½è®¤è¯ -->
                <div id="tab-verification" class="tab-content">
                    <div class="content-header">
                        <h2 class="content-title">èº«ä»½è®¤è¯</h2>
                    </div>
                    <div id="verificationContent">
                        <div class="info-card">
                            <h3 style="margin-bottom: 1rem;">è®¤è¯è¯´æ˜</h3>
                            <p style="color: #666; line-height: 1.8;">
                                é€šè¿‡èº«ä»½è®¤è¯åï¼Œæ‚¨å°†è·å¾—ï¼š<br>
                                âœ… è®¤è¯æ ‡è¯†å±•ç¤º<br>
                                âœ… æ›´é«˜çš„ä¿¡ä»»åº¦<br>
                                âœ… ä¼˜å…ˆå±•ç¤ºæœºä¼š<br>
                                âœ… æ›´å¤šå®¶é•¿/å­¦ç”Ÿå…³æ³¨
                            </p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openVerificationModal()">ç”³è¯·è®¤è¯</button>
                        </div>
                    </div>
                </div>

                <!-- è´¦å·å®‰å…¨ -->
                <div id="tab-security" class="tab-content">
                    <div class="content-header">
                        <h2 class="content-title">è´¦å·å®‰å…¨</h2>
                    </div>
                    <div class="info-card">
                        <h3 style="margin-bottom: 1rem;">ä¿®æ”¹å¯†ç </h3>
                        <form id="passwordForm">
                            <div class="form-group">
                                <label>å½“å‰å¯†ç </label>
                                <input type="password" id="oldPassword" required>
                            </div>
                            <div class="form-group">
                                <label>æ–°å¯†ç </label>
                                <input type="password" id="newPassword" required minlength="8">
                            </div>
                            <div class="form-group">
                                <label>ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" id="confirmNewPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="editModalTitle">ç¼–è¾‘</h3>
                <button class="close-btn" onclick="closeModal('editModal')">Ã—</button>
            </div>
            <form id="editForm"></form>
        </div>
    </div>

    <!-- è®¤è¯æ¨¡æ€æ¡† -->
    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç”³è¯·èº«ä»½è®¤è¯</h3>
                <button class="close-btn" onclick="closeModal('verificationModal')">Ã—</button>
            </div>
            <form id="verificationForm">
                <div class="form-group">
                    <label>çœŸå®å§“å</label>
                    <input type="text" id="verifyName" required>
                </div>
                <div class="form-group">
                    <label>èº«ä»½è¯å·</label>
                    <input type="text" id="verifyIdCard" required maxlength="18">
                </div>
                <div class="form-group">
                    <label>å­¦æ ¡åç§°</label>
                    <input type="text" id="verifySchool" placeholder="å¦‚ï¼šæ¸…åå¤§å­¦">
                </div>
                <div class="form-group">
                    <label>ä¸“ä¸š</label>
                    <input type="text" id="verifyMajor" placeholder="å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯">
                </div>
                <div class="form-group">
                    <label>è®¤è¯è¯´æ˜</label>
                    <textarea id="verifyNote" rows="3" placeholder="è¯·ç®€è¦è¯´æ˜æ‚¨çš„æ•™å­¦ç»å†å’Œèµ„è´¨"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤è®¤è¯ç”³è¯·</button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (!currentUser || !currentUser.id) {
                window.location.href = 'login.html';
                return;
            }
            loadUserProfile();
            loadStatistics();
            loadMyTutorProfiles();
            loadMyRequests();
            loadFavorites();
            loadOrders();
            loadMessages();
            loadReviews();
        });

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
        }

        // åŠ è½½ç”¨æˆ·èµ„æ–™
        function loadUserProfile() {
            fetch(`api_user.php?action=get_profile&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const user = data.data;
                        // æ˜¾ç¤ºæ˜µç§°ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå¦åˆ™æ˜¾ç¤ºç”¨æˆ·å
                        const displayNameText = user.nickname || user.username;
                        document.getElementById('userAvatar').textContent = (displayNameText || 'ç”¨')[0];
                        document.getElementById('displayName').textContent = displayNameText;
                        document.getElementById('userType').textContent = getUserTypeText(user.user_type);
                        document.getElementById('profileUsername').value = user.username;
                        document.getElementById('profileNickname').value = user.nickname || '';
                        document.getElementById('profileEmail').value = user.email;
                        document.getElementById('profilePhone').value = user.phone || '';
                        document.getElementById('profileUserType').value = user.user_type || 'both';
                        if (user.is_verified) {
                            document.getElementById('verifiedBadge').style.display = 'inline-block';
                        }
                    }
                });
        }

        function getUserTypeText(type) {
            const types = { 'parent': 'å®¶é•¿', 'tutor': 'å®¶æ•™è€å¸ˆ', 'both': 'å®¶é•¿/å®¶æ•™' };
            return types[type] || 'æ™®é€šç”¨æˆ·';
        }

        // åŠ è½½ç»Ÿè®¡
        function loadStatistics() {
            fetch(`api_user.php?action=get_statistics&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.data;
                        document.getElementById('statProfiles').textContent = stats.tutor_profiles || 0;
                        document.getElementById('statRequests').textContent = stats.requests || 0;
                        document.getElementById('statFavorites').textContent = stats.favorites || 0;
                        document.getElementById('statOrders').textContent = stats.orders || 0;
                        document.getElementById('statMessages').textContent = stats.unread_messages || 0;
                        if (stats.unread_messages > 0) {
                            document.getElementById('msgBadge').textContent = stats.unread_messages;
                            document.getElementById('msgBadge').style.display = 'inline';
                        }
                    }
                });
        }

        // ä¿å­˜ä¸ªäººèµ„æ–™
        function saveProfile() {
            const newEmail = document.getElementById('profileEmail').value;
            const newNickname = document.getElementById('profileNickname').value;
            const newPhone = document.getElementById('profilePhone').value;
            const newUserType = document.getElementById('profileUserType').value;
            
            fetch('api_user.php?action=update_profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    nickname: newNickname,
                    email: newEmail,
                    phone: newPhone,
                    user_type: newUserType
                })
            })
            .then(r => r.json())
            .then(data => {
                showMessage(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    // æ›´æ–°localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯
                    currentUser.nickname = newNickname;
                    currentUser.email = newEmail;
                    currentUser.phone = newPhone;
                    currentUser.user_type = newUserType;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    loadUserProfile();
                    // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
                    const displayName = newNickname || currentUser.username;
                    document.getElementById('displayName').textContent = displayName;
                    document.getElementById('userAvatar').textContent = displayName[0];
                    document.getElementById('userType').textContent = getUserTypeText(newUserType);
                }
            })
            .catch(err => {
                console.error('ä¿å­˜å¤±è´¥:', err);
                showMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }

        // åŠ è½½æˆ‘çš„å®¶æ•™ä¿¡æ¯
        function loadMyTutorProfiles() {
            fetch(`api_user.php?action=get_my_tutor_profiles&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('myTutorList');
                    if (data.success && data.data.length > 0) {
                        container.innerHTML = data.data.map(p => `
                            <div class="info-card">
                                <div class="info-header">
                                    <span class="info-title">${p.name} - ${p.subjects}</span>
                                    <span class="info-status status-${p.status}">${p.status === 'active' ? 'å±•ç¤ºä¸­' : 'å·²ä¸‹æ¶'}</span>
                                </div>
                                <div class="info-meta">ğŸ“ ${p.education} | ğŸ’¼ ${p.experience} | ğŸ’° ${p.salary}</div>
                                <div class="info-meta">ğŸ“ ${p.teaching_areas} | â° ${p.schedule}</div>
                                <div class="info-actions">
                                    <button class="btn btn-primary" onclick="editTutorProfile(${p.id})">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" onclick="deleteTutorProfile(${p.id})">åˆ é™¤</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><p>æš‚æ— å‘å¸ƒçš„å®¶æ•™ä¿¡æ¯</p></div>';
                    }
                });
        }

        // åŠ è½½æˆ‘çš„éœ€æ±‚
        function loadMyRequests() {
            fetch(`api_user.php?action=get_my_requests&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('myRequestsList');
                    if (data.success && data.data.length > 0) {
                        container.innerHTML = data.data.map(r => `
                            <div class="info-card">
                                <div class="info-header">
                                    <span class="info-title">${r.student_name} (${r.grade}) - ${r.subjects}</span>
                                    <span class="info-status status-${r.status}">${r.status === 'active' ? 'æ‹›å‹Ÿä¸­' : 'å·²ç»“æŸ'}</span>
                                </div>
                                <div class="info-meta">ğŸ“ ${r.location} | â° ${r.schedule} | ğŸ’° ${r.salary}</div>
                                <div class="info-actions">
                                    <button class="btn btn-primary" onclick="editRequest(${r.id})">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" onclick="deleteRequest(${r.id})">åˆ é™¤</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><p>æš‚æ— å‘å¸ƒçš„éœ€æ±‚</p></div>';
                    }
                });
        }

        // åˆ é™¤å®¶æ•™ä¿¡æ¯
        function deleteTutorProfile(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å®¶æ•™ä¿¡æ¯å—ï¼Ÿ')) return;
            fetch('api_user.php?action=delete_tutor_profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile_id: id, user_id: currentUser.id })
            })
            .then(r => r.json())
            .then(data => {
                showMessage(data.message, data.success ? 'success' : 'error');
                if (data.success) loadMyTutorProfiles();
            });
        }

        // åˆ é™¤éœ€æ±‚
        function deleteRequest(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡éœ€æ±‚å—ï¼Ÿ')) return;
            fetch('api_user.php?action=delete_request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: id, user_id: currentUser.id })
            })
            .then(r => r.json())
            .then(data => {
                showMessage(data.message, data.success ? 'success' : 'error');
                if (data.success) loadMyRequests();
            });
        }

        // åŠ è½½æ”¶è—
        function loadFavorites() {
            fetch(`api_favorites.php?action=get_list&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('favoritesList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(f => `
                            <div class="info-card">
                                <div class="info-header">
                                    <span class="info-title">${f.title}</span>
                                    <span class="info-status">${f.type === 'tutor' ? 'å®¶æ•™è€å¸ˆ' : 'å®¶æ•™éœ€æ±‚'}</span>
                                </div>
                                <div class="info-meta">${f.description}</div>
                                <div class="info-actions">
                                    <button class="btn btn-danger" onclick="removeFavorite(${f.id})">å–æ¶ˆæ”¶è—</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="icon">â­</div><p>æš‚æ— æ”¶è—</p></div>';
                    }
                })
                .catch(() => {
                    document.getElementById('favoritesList').innerHTML = '<div class="empty-state"><div class="icon">â­</div><p>æš‚æ— æ”¶è—</p></div>';
                });
        }

        // åŠ è½½è®¢å•
        function loadOrders() {
            fetch(`api_orders.php?action=get_list&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('ordersList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(o => `
                            <div class="info-card">
                                <div class="info-header">
                                    <span class="info-title">è®¢å• #${o.order_no}</span>
                                    <span class="info-status status-${o.status}">${getOrderStatusText(o.status)}</span>
                                </div>
                                <div class="info-meta">ğŸ“š ${o.subjects} | ğŸ“ ${o.location} | ğŸ’° ${o.total_amount}å…ƒ</div>
                                <div class="info-actions">
                                    <button class="btn btn-primary" onclick="viewOrderDetail(${o.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><p>æš‚æ— è®¢å•</p></div>';
                    }
                })
                .catch(() => {
                    document.getElementById('ordersList').innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><p>æš‚æ— è®¢å•</p></div>';
                });
        }

        function getOrderStatusText(status) {
            const statusMap = {
                'pending': 'å¾…ç¡®è®¤', 'accepted': 'å·²æ¥å—', 'rejected': 'å·²æ‹’ç»',
                'ongoing': 'è¿›è¡Œä¸­', 'completed': 'å·²å®Œæˆ', 'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // åŠ è½½æ¶ˆæ¯
        function loadMessages() {
            fetch(`api_messages.php?action=get_list&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('messagesList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(m => `
                            <div class="info-card" style="${m.is_read ? '' : 'border-left: 3px solid #667eea;'}">
                                <div class="info-header">
                                    <span class="info-title">${m.subject || 'æ— ä¸»é¢˜'}</span>
                                    <span style="color: #666; font-size: 0.8rem;">${m.created_at}</span>
                                </div>
                                <div class="info-meta">${m.content.substring(0, 100)}${m.content.length > 100 ? '...' : ''}</div>
                                <div class="info-actions">
                                    <button class="btn btn-primary" onclick="viewMessage(${m.id})">æŸ¥çœ‹</button>
                                    ${!m.is_read ? '<button class="btn btn-secondary" onclick="markRead(' + m.id + ')">æ ‡è®°å·²è¯»</button>' : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’¬</div><p>æš‚æ— æ¶ˆæ¯</p></div>';
                    }
                })
                .catch(() => {
                    document.getElementById('messagesList').innerHTML = '<div class="empty-state"><div class="icon">ğŸ’¬</div><p>æš‚æ— æ¶ˆæ¯</p></div>';
                });
        }

        // åŠ è½½è¯„ä»·
        function loadReviews() {
            fetch(`api_reviews.php?action=get_my_reviews&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('reviewsList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(r => `
                            <div class="info-card">
                                <div class="info-header">
                                    <span class="info-title">${'â­'.repeat(r.rating)}</span>
                                    <span style="color: #666; font-size: 0.8rem;">${r.created_at}</span>
                                </div>
                                <div class="info-meta">${r.content}</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="icon">â­</div><p>æš‚æ— è¯„ä»·</p></div>';
                    }
                })
                .catch(() => {
                    document.getElementById('reviewsList').innerHTML = '<div class="empty-state"><div class="icon">â­</div><p>æš‚æ— è¯„ä»·</p></div>';
                });
        }

        // ä¿®æ”¹å¯†ç 
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmNewPassword').value;
            
            if (newPwd !== confirmPwd) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            fetch('api_user.php?action=change_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    old_password: document.getElementById('oldPassword').value,
                    new_password: newPwd
                })
            })
            .then(r => r.json())
            .then(data => {
                showMessage(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    document.getElementById('passwordForm').reset();
                }
            });
        });

        // è®¤è¯ç›¸å…³
        function openVerificationModal() {
            document.getElementById('verificationModal').style.display = 'block';
        }

        document.getElementById('verificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            fetch('api_verification.php?action=submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    real_name: document.getElementById('verifyName').value,
                    id_card: document.getElementById('verifyIdCard').value,
                    school: document.getElementById('verifySchool').value,
                    major: document.getElementById('verifyMajor').value,
                    note: document.getElementById('verifyNote').value
                })
            })
            .then(r => r.json())
            .then(data => {
                showMessage(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    closeModal('verificationModal');
                }
            });
        });

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        }

        // è·³è½¬åˆ°å‘å¸ƒå®¶æ•™ä¿¡æ¯é¡µé¢
        function goToPublishTutor() {
            window.location.href = 'index.html#publish-tutor';
        }
        
        // è·³è½¬åˆ°å‘å¸ƒå®¶æ•™éœ€æ±‚é¡µé¢
        function goToPublishRequest() {
            window.location.href = 'index.html#publish-request';
        }

        // å ä½å‡½æ•°
        function editTutorProfile(id) { showMessage('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­', 'info'); }
        function editRequest(id) { showMessage('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­', 'info'); }
        function removeFavorite(id) { 
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæ”¶è—å—ï¼Ÿ')) return;
            fetch('api_favorites.php?action=remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ favorite_id: id, user_id: currentUser.id })
            })
            .then(r => r.json())
            .then(data => {
                showMessage(data.message, data.success ? 'success' : 'error');
                if (data.success) loadFavorites();
            });
        }
        function viewOrderDetail(id) { showMessage('è®¢å•è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­', 'info'); }
        function viewMessage(id) { showMessage('æ¶ˆæ¯è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­', 'info'); }
        function markRead(id) { showMessage('æ ‡è®°å·²è¯»åŠŸèƒ½å¼€å‘ä¸­', 'info'); }
        function markAllRead() { showMessage('å…¨éƒ¨å·²è¯»åŠŸèƒ½å¼€å‘ä¸­', 'info'); }
    </script>
</body>
</html>

