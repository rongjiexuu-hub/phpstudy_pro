<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - å­¦ç¼˜å®¶æ•™é€š</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 0;
            color: white;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo { font-size: 1.5rem; font-weight: bold; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 2rem; list-style: none; }
        .nav-links a { color: white; text-decoration: none; opacity: 0.9; transition: opacity 0.3s; }
        .nav-links a:hover { opacity: 1; }
        
        .main-container {
            max-width: 1200px;
            margin: 80px auto 40px;
            padding: 20px;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: fit-content;
        }
        
        .user-info {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 10px;
        }
        
        .user-name { font-size: 1.2rem; font-weight: 600; color: #333; }
        .user-type { font-size: 0.9rem; color: #666; margin-top: 5px; }
        
        .verified-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-top: 8px;
        }
        
        .unverified-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-top: 8px;
        }
        
        .menu-list { list-style: none; }
        
        .menu-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #555;
        }
        
        .menu-item:hover { background: #f5f7fa; color: #667eea; }
        .menu-item.active { background: #667eea; color: white; }
        .menu-item .badge { background: #dc3545; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: auto; }
        
        /* ä¸»å†…å®¹åŒº */
        .content-area {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        /* å¡ç‰‡åˆ—è¡¨ */
        .card-list { display: grid; gap: 15px; }
        
        .info-card {
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .info-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .card-title { font-size: 1.1rem; font-weight: 600; color: #333; }
        
        .card-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .status-active { background: #d4edda; color: #28a745; }
        .status-inactive { background: #f8d7da; color: #dc3545; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        .card-meta {
            display: flex;
            gap: 20px;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd8; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-outline { background: white; border: 1px solid #667eea; color: #667eea; }
        .btn-outline:hover { background: #667eea; color: white; }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon { font-size: 4rem; margin-bottom: 20px; }
        .empty-state p { font-size: 1.1rem; margin-bottom: 20px; }
        
        /* æ ‡ç­¾é¡µå†…å®¹ */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* æ¶ˆæ¯æç¤º */
        .message {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }
        
        .message.success { background: #28a745; }
        .message.error { background: #dc3545; }
        .message.info { background: #17a2b8; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                margin-top: 70px;
            }
            
            .sidebar { display: none; }
            
            .nav-links { display: none; }
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number { font-size: 2rem; font-weight: bold; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">å­¦ç¼˜å®¶æ•™é€š</a>
            <ul class="nav-links">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="user_center.html">ä¸ªäººä¸­å¿ƒ</a></li>
                <li><a href="#" onclick="logout()">é€€å‡ºç™»å½•</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div class="user-name" id="userName">ç”¨æˆ·å</div>
                <div class="user-type" id="userType">æ™®é€šç”¨æˆ·</div>
                <span class="unverified-badge" id="verifyBadge">æœªè®¤è¯</span>
            </div>
            
            <ul class="menu-list">
                <li class="menu-item active" onclick="showTab('overview')">
                    ğŸ“Š ä¸ªäººæ¦‚è§ˆ
                </li>
                <li class="menu-item" onclick="showTab('my-posts')">
                    ğŸ“ æˆ‘çš„å‘å¸ƒ
                </li>
                <li class="menu-item" onclick="showTab('my-orders')">
                    ğŸ“‹ æˆ‘çš„è®¢å•
                </li>
                <li class="menu-item" onclick="showTab('my-favorites')">
                    â­ æˆ‘çš„æ”¶è—
                </li>
                <li class="menu-item" onclick="showTab('messages')">
                    ğŸ’¬ æ¶ˆæ¯ä¸­å¿ƒ
                    <span class="badge" id="unreadCount" style="display: none;">0</span>
                </li>
                <li class="menu-item" onclick="showTab('verification')">
                    âœ… èº«ä»½è®¤è¯
                </li>
                <li class="menu-item" onclick="showTab('settings')">
                    âš™ï¸ è´¦å·è®¾ç½®
                </li>
            </ul>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="content-area">
            <!-- ä¸ªäººæ¦‚è§ˆ -->
            <div id="overview" class="tab-content active">
                <h2 class="section-title">ğŸ“Š ä¸ªäººæ¦‚è§ˆ</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="statPosts">0</div>
                        <div class="stat-label">å‘å¸ƒæ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statOrders">0</div>
                        <div class="stat-label">è®¢å•æ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statFavorites">0</div>
                        <div class="stat-label">æ”¶è—æ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statMessages">0</div>
                        <div class="stat-label">æœªè¯»æ¶ˆæ¯</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: #333;">æœ€è¿‘æ´»åŠ¨</h3>
                <div class="card-list" id="recentActivity">
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <p>æš‚æ— æœ€è¿‘æ´»åŠ¨</p>
                    </div>
                </div>
            </div>

            <!-- æˆ‘çš„å‘å¸ƒ -->
            <div id="my-posts" class="tab-content">
                <h2 class="section-title">ğŸ“ æˆ‘çš„å‘å¸ƒ</h2>
                <div class="card-list" id="myPostsList">
                    <div class="empty-state">
                        <div class="icon">ğŸ“</div>
                        <p>æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•ä¿¡æ¯</p>
                        <button class="btn btn-primary" onclick="location.href='index.html'">å»å‘å¸ƒ</button>
                    </div>
                </div>
            </div>

            <!-- æˆ‘çš„è®¢å• -->
            <div id="my-orders" class="tab-content">
                <h2 class="section-title">ğŸ“‹ æˆ‘çš„è®¢å•</h2>
                <div class="card-list" id="myOrdersList">
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <p>æš‚æ— è®¢å•è®°å½•</p>
                    </div>
                </div>
            </div>

            <!-- æˆ‘çš„æ”¶è— -->
            <div id="my-favorites" class="tab-content">
                <h2 class="section-title">â­ æˆ‘çš„æ”¶è—</h2>
                <div class="card-list" id="myFavoritesList">
                    <div class="empty-state">
                        <div class="icon">â­</div>
                        <p>æ‚¨è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•ä¿¡æ¯</p>
                        <button class="btn btn-primary" onclick="location.href='index.html'">å»æµè§ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯ä¸­å¿ƒ -->
            <div id="messages" class="tab-content">
                <h2 class="section-title">ğŸ’¬ æ¶ˆæ¯ä¸­å¿ƒ</h2>
                <div class="card-list" id="messagesList">
                    <div class="empty-state">
                        <div class="icon">ğŸ’¬</div>
                        <p>æš‚æ— æ¶ˆæ¯</p>
                    </div>
                </div>
            </div>

            <!-- èº«ä»½è®¤è¯ -->
            <div id="verification" class="tab-content">
                <h2 class="section-title">âœ… èº«ä»½è®¤è¯</h2>
                
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-title">ğŸªª å®åè®¤è¯</span>
                        <span class="card-status status-pending" id="idCardStatus">æœªè®¤è¯</span>
                    </div>
                    <p style="color: #666; margin-bottom: 15px;">å®Œæˆå®åè®¤è¯åï¼Œæ‚¨å‘å¸ƒçš„ä¿¡æ¯å°†è·å¾—"å·²è®¤è¯"æ ‡è¯†ï¼Œæ›´å®¹æ˜“è·å¾—ä¿¡ä»»ã€‚</p>
                    <form id="idCardForm">
                        <div class="form-group">
                            <label>çœŸå®å§“å</label>
                            <input type="text" id="realName" placeholder="è¯·è¾“å…¥èº«ä»½è¯ä¸Šçš„å§“å" required>
                        </div>
                        <div class="form-group">
                            <label>èº«ä»½è¯å·ç </label>
                            <input type="text" id="idNumber" placeholder="è¯·è¾“å…¥18ä½èº«ä»½è¯å·ç " maxlength="18" required>
                        </div>
                        <button type="submit" class="btn btn-primary">æäº¤è®¤è¯</button>
                    </form>
                </div>

                <div class="info-card" style="margin-top: 20px;">
                    <div class="card-header">
                        <span class="card-title">ğŸ“ å­¦å†è®¤è¯</span>
                        <span class="card-status status-pending" id="eduStatus">æœªè®¤è¯</span>
                    </div>
                    <p style="color: #666; margin-bottom: 15px;">ä¸Šä¼ å­¦å†è¯ä¹¦ï¼Œè¯æ˜æ‚¨çš„æ•™è‚²èƒŒæ™¯ã€‚</p>
                    <form id="educationForm">
                        <div class="form-group">
                            <label>å­¦å†è¯ä¹¦ç…§ç‰‡</label>
                            <input type="file" id="eduCertFile" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary">æäº¤è®¤è¯</button>
                    </form>
                </div>
            </div>

            <!-- è´¦å·è®¾ç½® -->
            <div id="settings" class="tab-content">
                <h2 class="section-title">âš™ï¸ è´¦å·è®¾ç½®</h2>
                
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-title">åŸºæœ¬ä¿¡æ¯</span>
                    </div>
                    <form id="profileForm">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="editUsername" disabled>
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±</label>
                            <input type="email" id="editEmail">
                        </div>
                        <div class="form-group">
                            <label>æ‰‹æœºå·</label>
                            <input type="tel" id="editPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                        </div>
                        <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                    </form>
                </div>

                <div class="info-card" style="margin-top: 20px;">
                    <div class="card-header">
                        <span class="card-title">ä¿®æ”¹å¯†ç </span>
                    </div>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label>å½“å‰å¯†ç </label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label>æ–°å¯†ç </label>
                            <input type="password" id="newPassword" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label>ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" id="confirmNewPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentUser = null;

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            loadUserData();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (!currentUser || !currentUser.id) {
                showMessage('è¯·å…ˆç™»å½•', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return false;
            }
            return true;
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        function loadUserData() {
            if (!currentUser) return;
            
            // æ›´æ–°å¤´åƒå’Œç”¨æˆ·å
            document.getElementById('userAvatar').textContent = (currentUser.fullName || currentUser.username).charAt(0);
            document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
            document.getElementById('userType').textContent = getUserTypeText(currentUser.user_type);
            
            // æ›´æ–°è¡¨å•
            document.getElementById('editUsername').value = currentUser.username || '';
            document.getElementById('editEmail').value = currentUser.email || '';
            document.getElementById('editPhone').value = currentUser.phone || '';
            
            // åŠ è½½å„é¡¹æ•°æ®
            loadMyPosts();
            loadMyOrders();
            loadMyFavorites();
            loadMessages();
            loadStats();
        }

        // è·å–ç”¨æˆ·ç±»å‹æ–‡æœ¬
        function getUserTypeText(type) {
            const types = {
                'student': 'å­¦ç”Ÿ',
                'tutor': 'å®¶æ•™è€å¸ˆ',
                'parent': 'å®¶é•¿'
            };
            return types[type] || 'æ™®é€šç”¨æˆ·';
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tabId) {
            // éšè—æ‰€æœ‰å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰èœå•é¡¹çš„æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
            document.getElementById(tabId).classList.add('active');
            
            // è®¾ç½®èœå•é¡¹æ´»åŠ¨çŠ¶æ€
            event.target.closest('.menu-item').classList.add('active');
        }

        // åŠ è½½æˆ‘çš„å‘å¸ƒ
        function loadMyPosts() {
            const container = document.getElementById('myPostsList');
            
            // åŒæ—¶åŠ è½½å®¶æ•™ä¿¡æ¯å’Œéœ€æ±‚
            Promise.all([
                fetch(`api_get_tutor_profiles.php?user_id=${currentUser.id}`).then(r => r.json()),
                fetch(`api_get_tutoring_requests.php?user_id=${currentUser.id}`).then(r => r.json())
            ])
            .then(([tutorData, requestData]) => {
                let html = '';
                let count = 0;
                
                // å®¶æ•™ä¿¡æ¯
                if (tutorData.success && tutorData.data.profiles) {
                    tutorData.data.profiles.forEach(item => {
                        count++;
                        html += createPostCard(item, 'tutor');
                    });
                }
                
                // å®¶æ•™éœ€æ±‚
                if (requestData.success && requestData.data.requests) {
                    requestData.data.requests.forEach(item => {
                        count++;
                        html += createPostCard(item, 'request');
                    });
                }
                
                if (count === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“</div>
                            <p>æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•ä¿¡æ¯</p>
                            <button class="btn btn-primary" onclick="location.href='index.html'">å»å‘å¸ƒ</button>
                        </div>`;
                } else {
                    container.innerHTML = html;
                }
                
                document.getElementById('statPosts').textContent = count;
            })
            .catch(error => {
                console.error('åŠ è½½å‘å¸ƒå¤±è´¥:', error);
            });
        }

        // åˆ›å»ºå‘å¸ƒå¡ç‰‡
        function createPostCard(item, type) {
            const statusClass = item.status === 'active' ? 'status-active' : 'status-inactive';
            const statusText = item.status === 'active' ? 'å·²å‘å¸ƒ' : 'å·²ä¸‹æ¶';
            const typeText = type === 'tutor' ? 'å®¶æ•™ä¿¡æ¯' : 'å®¶æ•™éœ€æ±‚';
            const title = type === 'tutor' ? item.name : item.student_name;
            
            return `
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-title">${title} <small style="color: #666;">(${typeText})</small></span>
                        <span class="card-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="card-meta">
                        <span>ğŸ“š ${item.subjects}</span>
                        <span>ğŸ“ ${item.location || item.teaching_areas}</span>
                        <span>ğŸ’° ${item.salary}</span>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline" onclick="editPost(${item.id}, '${type}')">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deletePost(${item.id}, '${type}')">åˆ é™¤</button>
                    </div>
                </div>`;
        }

        // åŠ è½½æˆ‘çš„è®¢å•
        function loadMyOrders() {
            fetch(`api_get_orders.php?user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('myOrdersList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(order => createOrderCard(order)).join('');
                        document.getElementById('statOrders').textContent = data.data.length;
                    }
                })
                .catch(error => console.error('åŠ è½½è®¢å•å¤±è´¥:', error));
        }

        // åˆ›å»ºè®¢å•å¡ç‰‡
        function createOrderCard(order) {
            const statusMap = {
                'pending': { text: 'å¾…ç¡®è®¤', class: 'status-pending' },
                'confirmed': { text: 'å·²ç¡®è®¤', class: 'status-active' },
                'in_progress': { text: 'è¿›è¡Œä¸­', class: 'status-active' },
                'completed': { text: 'å·²å®Œæˆ', class: 'status-active' },
                'cancelled': { text: 'å·²å–æ¶ˆ', class: 'status-inactive' }
            };
            const status = statusMap[order.status] || statusMap['pending'];
            
            return `
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-title">è®¢å•å·: ${order.order_no}</span>
                        <span class="card-status ${status.class}">${status.text}</span>
                    </div>
                    <div class="card-meta">
                        <span>ğŸ“š ${order.subjects}</span>
                        <span>ğŸ’° Â¥${order.total_amount || 0}</span>
                        <span>ğŸ“… ${order.created_at}</span>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline" onclick="viewOrder(${order.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                    </div>
                </div>`;
        }

        // åŠ è½½æˆ‘çš„æ”¶è—
        function loadMyFavorites() {
            fetch(`api_favorites.php?action=list&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('myFavoritesList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(fav => createFavoriteCard(fav)).join('');
                        document.getElementById('statFavorites').textContent = data.data.length;
                    }
                })
                .catch(error => console.error('åŠ è½½æ”¶è—å¤±è´¥:', error));
        }

        // åˆ›å»ºæ”¶è—å¡ç‰‡
        function createFavoriteCard(fav) {
            return `
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-title">${fav.title}</span>
                        <span class="card-status status-active">${fav.item_type === 'tutor' ? 'å®¶æ•™è€å¸ˆ' : 'å®¶æ•™éœ€æ±‚'}</span>
                    </div>
                    <div class="card-meta">
                        <span>ğŸ“š ${fav.subjects}</span>
                        <span>ğŸ“ ${fav.location}</span>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline" onclick="viewFavorite(${fav.item_id}, '${fav.item_type}')">æŸ¥çœ‹</button>
                        <button class="btn btn-danger" onclick="removeFavorite(${fav.id})">å–æ¶ˆæ”¶è—</button>
                    </div>
                </div>`;
        }

        // åŠ è½½æ¶ˆæ¯
        function loadMessages() {
            fetch(`api_messages.php?action=list&user_id=${currentUser.id}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('messagesList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(msg => createMessageCard(msg)).join('');
                        const unread = data.data.filter(m => !m.is_read).length;
                        if (unread > 0) {
                            document.getElementById('unreadCount').textContent = unread;
                            document.getElementById('unreadCount').style.display = 'inline';
                        }
                        document.getElementById('statMessages').textContent = unread;
                    }
                })
                .catch(error => console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error));
        }

        // åˆ›å»ºæ¶ˆæ¯å¡ç‰‡
        function createMessageCard(msg) {
            const readClass = msg.is_read ? '' : 'style="background: #f8f9fa;"';
            return `
                <div class="info-card" ${readClass}>
                    <div class="card-header">
                        <span class="card-title">æ¥è‡ª: ${msg.sender_name}</span>
                        <span style="color: #666; font-size: 0.85rem;">${msg.created_at}</span>
                    </div>
                    <p style="color: #555; line-height: 1.6;">${msg.content}</p>
                    <div class="card-actions">
                        <button class="btn btn-primary" onclick="replyMessage(${msg.sender_id})">å›å¤</button>
                        ${!msg.is_read ? `<button class="btn btn-outline" onclick="markAsRead(${msg.id})">æ ‡è®°å·²è¯»</button>` : ''}
                    </div>
                </div>`;
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            // ç»Ÿè®¡æ•°æ®å·²åœ¨å„ä¸ªåŠ è½½å‡½æ•°ä¸­æ›´æ–°
        }

        // åˆ é™¤å‘å¸ƒ
        function deletePost(id, type) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å‘å¸ƒå—ï¼Ÿ')) return;
            
            const api = type === 'tutor' ? 'api_delete_tutor_profile.php' : 'api_delete_tutoring_request.php';
            
            fetch(api, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, user_id: currentUser.id })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadMyPosts();
                } else {
                    showMessage(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            });
        }

        // ç¼–è¾‘å‘å¸ƒ
        function editPost(id, type) {
            showMessage('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // å–æ¶ˆæ”¶è—
        function removeFavorite(id) {
            fetch('api_favorites.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'remove', id: id, user_id: currentUser.id })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showMessage('å·²å–æ¶ˆæ”¶è—', 'success');
                    loadMyFavorites();
                }
            });
        }

        // å›å¤æ¶ˆæ¯
        function replyMessage(senderId) {
            const content = prompt('è¯·è¾“å…¥å›å¤å†…å®¹:');
            if (!content) return;
            
            fetch('api_messages.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'send',
                    sender_id: currentUser.id,
                    receiver_id: senderId,
                    content: content
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showMessage('å›å¤æˆåŠŸ', 'success');
                } else {
                    showMessage(data.message || 'å‘é€å¤±è´¥', 'error');
                }
            });
        }

        // æ ‡è®°å·²è¯»
        function markAsRead(msgId) {
            fetch('api_messages.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'read', id: msgId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    loadMessages();
                }
            });
        }

        // æäº¤èº«ä»½è®¤è¯
        document.getElementById('idCardForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                user_id: currentUser.id,
                type: 'id_card',
                real_name: document.getElementById('realName').value,
                id_number: document.getElementById('idNumber').value
            };
            
            fetch('api_verification.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showMessage('è®¤è¯ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…å®¡æ ¸', 'success');
                    document.getElementById('idCardStatus').textContent = 'å®¡æ ¸ä¸­';
                    document.getElementById('idCardStatus').className = 'card-status status-pending';
                } else {
                    showMessage(data.message || 'æäº¤å¤±è´¥', 'error');
                }
            });
        });

        // ä¿®æ”¹å¯†ç 
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmNewPassword').value;
            
            if (newPass !== confirmPass) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            fetch('api_change_password.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    current_password: document.getElementById('currentPassword').value,
                    new_password: newPass
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showMessage('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
                    this.reset();
                } else {
                    showMessage(data.message || 'ä¿®æ”¹å¤±è´¥', 'error');
                }
            });
        });

        // ä¿å­˜ä¸ªäººä¿¡æ¯
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            fetch('api_update_profile.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showMessage('ä¿å­˜æˆåŠŸ', 'success');
                    // æ›´æ–°æœ¬åœ°å­˜å‚¨
                    currentUser.email = document.getElementById('editEmail').value;
                    currentUser.phone = document.getElementById('editPhone').value;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                } else {
                    showMessage(data.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            });
        });

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }
    </script>
</body>
</html>

